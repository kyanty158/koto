# KOTO 要件定義書 (MVP, rev 2)

> 現行実装に準拠して再定義。最短入力と軽量操作を最優先し、オフライン保存＋ローカル通知で「書くは一瞬、思い出すは一目」を実現する。

---

## 0. 用語
- KOTO: 本アプリ
- Basic: 無料プラン
- Pro: サブスクリプションプラン
- Cold/Warm: アプリの初回/復帰起動

---

## 1. 目的・非目的
### 1.1 目的
- 起動→入力までの摩擦を最小化（入力開始まで1秒前後）
- 直感的な3方向ドラッグとミニマルUI
- オフラインでも安全・高速な保存と確実なリマインド

### 1.2 非目的（MVP）
- 階層的な整理/共有/共同編集
- 複雑なタグ管理UI（抽出は自動）
- Web同時リリース

---

## 2. 対象ユーザー
- 「今すぐ書きたい」ライト〜ミドルユーザー
- 片手/移動中の利用が多いユーザー

---

## 3. 提供価値
- 起動即キーボードで思考を止めない
- 左/右/下の3動作で完結（破棄/リマインド/保存）
- 整理不要。あとから検索（Pro）や `#タグ` 抽出で見つかる

---

## 4. コアUX（実装準拠）
### 4.1 書く（Write）
- 起動後すぐフォーカスしてキーボード表示
- 入力カードは横長・固定高（非表示時: 約200 / キーボード時: 約160）
- ジェスチャ（右ハンドル起点）
  - 右: クイックリマインドレール（10/20/30/45/60/90/120/180/240/360m, 今夜(20:00), 明日朝(9:00)）
    - 候補上でドロップ→即保存＋通知
    - 高速ドロップでも「ラッチ済み or カーソル位置 or デフォルト」の順で時刻を確定
  - 左: 破棄（Snackbar表示）
  - 下: 通常保存（通知なし）
- 2本指タップ: 直前の保存取り消し（通知キャンセル）、または直前破棄の復帰
- フィードバック: 保存完了チップ/付箋、Haptic
- Basic制限: リマインダーは月5回（Isar集計）。超過時はエラースナックバー

### 4.2 見る（View）
- 作成日時降順のリスト
- 未来リマインド・未完了は「これからのリマインド」として先頭に最大6件
- 検索（Proのみ）: 全文/`#タグ`（簡易）
- 選択モード: 一括削除、すべて選択/解除

### 4.3 編集（Edit）
- 本文、完了フラグ、リマインド（クイック/日時指定）
- 保存/削除はIsar更新＋通知スケジュール/キャンセル

---

## 5. 機能要件（詳細）
### 5.1 データモデル（Isar: Memo）
- id:int(auto), text:string, createdAt/updatedAt:DateTime(UTC)
- reminderAt:DateTime?(UTC), isDone:bool
- inlineTags: List<string>（`#tag` 自動抽出, 小文字化, 重複排除）
- インデックス: text(lower), createdAt, updatedAt, reminderAt, inlineTags(hash)

### 5.2 リマインド/通知
- flutter_local_notifications を使用
- アクション: 完了/スヌーズ(+15m)/編集を開く
- 予定の再登録・キャンセルに対応
- タイムゾーン: UTC保存/端末TZ表示、zonedScheduleで精度確保

### 5.3 サブスクリプション（段階的実装）
- Stateで `free/pro` を切替（現状は free）
- Basic: 表示50件・検索非表示・月5回制限
- Pro: 制限解除・検索有効（同期は将来対応）

### 5.4 ジェスチャ判定
- 右ドラッグでレール表示（しきい値は緩め）
- 位置確定は「ホバー確定/カーソル位置/デフォルト（例: 1時間後→10分後）」の順

---

## 6. 非機能要件
### 6.1 性能
- Cold→入力可能: ≤1.2s(P50)/≤1.6s(P90)
- Warm→入力可能: ≤0.8s(P50)/≤1.2s(P90)

### 6.2 可用性・信頼性
- 保存/通知登録はエラー時に失敗をUIで明示
- Undoで直前のミスを最小化

### 6.3 アクセシビリティ
- 動的文字サイズ、弱めのHaptic

### 6.4 セキュリティ/プライバシー（MVP）
- ローカルDB（Isar）保存。将来の暗号化/パスコードは次期
- 通知内容はメモ本文を含む（ユーザーの機能期待を優先）

---

## 7. プラットフォーム/互換性
- iOS 15+（Podfile既定）
- Androidは標準サポート相当（要検証）
- Firebase設定ファイル（iOS）は将来の同期等で使用。現状は未配線でも動作

---

## 8. アーキテクチャ
- オフラインファースト。IsarをSSOTに採用
- Pro同期は Firestore 予定（LWW, updatedAt基準）
- UTC保存/ローカル表示でTZ差を吸収

---

## 9. KPI/計測
| 指標 | 目標 | 備考 |
|---|---|---|
| Cold→入力可能 | ≤1.2s (P50) / ≤1.6s (P90) | 実機計測 |
| Warm→入力可能 | ≤0.8s (P50) / ≤1.2s (P90) | 実機計測 |
| 入力完了率 | ≥85% | 起動60秒以内の保存 |
| クラッシュ率 | <1.0% | Sentry 予定 |

---

## 10. 受け入れ条件（AC）
- AC-01: 起動でキーボードが自動表示される
- AC-02: 右ドラッグ→候補上ドロップ→保存＋通知予約（高速ドロップも成功）
- AC-03: 左ドラッグで破棄、下ドラッグで保存（各Haptic/スナックバー）
- AC-04: 2本指タップで直前の保存/破棄をUndo
- AC-05: Basicで当月6件目のリマインドはブロック
- AC-06: 通知から完了/スヌーズ/編集が機能
- AC-07: ViewのPinned/通常表示、Pro時は検索可

---

## 11. テスト計画（概要）
- 単体: タグ抽出、月次集計、今夜/明日朝の算出
- ウィジェット: 右レールのヒット判定（未ラッチ/高速）、Undo、カード位置
- 統合: 通知アクション→DB反映→UI反映
- 実機: iOS（最新/1世代前）。Androidは追随

---

## 12. 既知の課題/未了
- iOSの `GoogleService-Info.plist` はRunnerへの組み込みが未完（ログ警告）。同期導入時に追加
- UIScene未採用のログは機能影響なし
- 一部Lint（未使用importなど）

---

## 13. ロードマップ
| フェーズ | 期間 | 内容 |
|---|---|---|
| MVP | 4–6週 | 書く/見る/通知/Undo/制限、内部配布 |
| β | 6–8週 | Pro検索/同期（Firestore）/ホームウィジェット |
| v1.0 | 4–6週 | 課金導入、エクスポート、申請 |
| v1.1+ | 継続 | i18n(EN)、AI候補、添付のOCR |

---

## 14. 変更履歴
- rev 2: 現行実装へ合わせ全面改訂（カードサイズ/ドラッグ保存ロジック/Basic制限の明文化 等）
- rev 1s: 起動目標を1秒化、KPI/AC/ロードマップ更新、差分明確化（2025-08-26）
